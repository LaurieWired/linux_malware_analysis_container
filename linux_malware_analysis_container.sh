#!/bin/bash

# Check if at least one argument was provided
if [ $# -eq 0 ]
then
  echo "Please provide at least one file name as a command line argument."
  exit 1
fi

image_name="linux-malware-analysis"
container_name="${image_name}_$(date +%s)"

# Build docker image if it doesn't exist
if [[ "$(docker images -q $image_name 2> /dev/null)" == "" ]]; then
  docker build -t $image_name .
fi

# Create a temporary tar file
tar_file="$(mktemp)"
tar -cf "$tar_file" "$@"

# Run container
docker run -d --network none --name $container_name $image_name sleep infinity

# Copy the tar file to the Docker container
docker cp "$tar_file" "$container_name:/home/app/files.tar"
docker exec "$container_name" tar -xf "/home/app/files.tar" -C "/home/app"
docker exec "$container_name" rm "/home/app/files.tar"

# Make ELF and bash scripts executable
docker exec "$container_name" /bin/sh -c 'find /home/app -type f -exec file {} \; | grep -E "bash script|ELF" | cut -d: -f1 | xargs chmod +x'

docker exec -it $container_name /bin/bash

# After the Docker container has finished running, kill and remove it
docker kill $container_name
docker rm $container_name

# Remove the temporary tar file
rm "$tar_file"
